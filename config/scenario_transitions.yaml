version: 1
metadata:
  updated_at: "2025-09-23"
  owner: "Codex"
  description: "State transition map derived from docs/SCENARIO_ENGINE_PLAN.md and –¢–ó."
  default_prompt_path: "prompts"

global:
  guards:
    - name: "safety_policy"
      prompt: "safety_policies.txt"
      apply_to_states: "*"
  metrics:
    - name: "scene_transition_total"
      labels: ["from", "to"]
    - name: "consultation_booked_total"
      labels: ["segment", "channel"]
    - name: "payment_offer_shown_total"
      labels: ["segment", "tariff"]

states:
  START:
    description: "Welcome message on /start, deliver bonus CTA."
    entry:
      steps:
        - action: "send_llm_response"
          prompt: "system_manager.txt"
          context:
            funnel_stage: "new"
            intent: "greeting"
          fallback_buttons:
            - text: "üéÅ –ü–æ–ª—É—á–∏—Ç—å –±–æ–Ω—É—Å"
              callback: "bonus:claim"
            - text: "üéØ –ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç"
              callback: "survey:start"
    transitions:
      - trigger: "command:/start"
        target: "BONUS_DELIVERY"
      - trigger: "callback:bonus:claim"
        target: "BONUS_DELIVERY"
      - trigger: "callback:survey:start"
        target: "SURVEY_ENTRY"
      - trigger: "callback:strategy:discuss"
        target: "STRATEGY_DISCUSSION"

  BONUS_DELIVERY:
    description: "–í—ã–¥–∞—á–∞ –±–æ–Ω—É—Å–æ–≤ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è."
    entry:
      steps:
        - action: "deliver_bonus"
        - action: "log_event"
          event_type: "bonus_delivered"
    transitions:
      - trigger: "bonus_delivered"
        target: "READINESS_CHECK"

  READINESS_CHECK:
    description: "–°–ø—Ä–∞—à–∏–≤–∞–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –ø—Ä–æ–π—Ç–∏ –∞–Ω–∫–µ—Ç—É –∏–ª–∏ –æ–±—Å—É–¥–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏."
    entry:
      steps:
        - action: "send_message"
          template: "–ì–æ—Ç–æ–≤ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å? –í—ã–±–µ—Ä–∏, —á—Ç–æ —É–¥–æ–±–Ω–µ–µ —Å–µ–π—á–∞—Å."
          buttons:
            - text: "üöÄ –ì–æ—Ç–æ–≤ –ø—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç"
              callback: "survey:start"
            - text: "ü§î –•–æ—á—É –æ–±—Å—É–¥–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏"
              callback: "strategy:discuss"
            - text: "üë§ –ú–µ–Ω–µ–¥–∂–µ—Ä"
              callback: "manager:request"
    transitions:
      - trigger: "callback:survey:start"
        target: "SURVEY_ENTRY"
      - trigger: "callback:strategy:discuss"
        target: "STRATEGY_DISCUSSION"
      - trigger: "callback:manager:request"
        target: "MANAGER_HOT_HANDOFF"

  STRATEGY_DISCUSSION:
    description: "–í–µ—Ç–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç—è—Ç –æ–±—Å—É–¥–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –≤–º–µ—Å—Ç–æ –∞–Ω–∫–µ—Ç—ã."
    entry:
      steps:
        - action: "send_llm_response"
          prompt: "materials_selector.txt"
          context:
            mode: "strategy_overview"
        - action: "offer_options"
          buttons:
            - text: "üõ°Ô∏è –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å"
              callback: "strategy:path:safety"
            - text: "üìà –†–æ—Å—Ç"
              callback: "strategy:path:growth"
            - text: "üéØ –ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç"
              callback: "survey:start"
    transitions:
      - trigger: "callback:strategy:path:safety"
        target: "SAFETY_PATH"
      - trigger: "callback:strategy:path:growth"
        target: "GROWTH_PATH"
      - trigger: "callback:survey:start"
        target: "SURVEY_ENTRY"

  SAFETY_PATH:
    description: "–ù–∞–¥—ë–∂–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ + CTA –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏."
    entry:
      steps:
        - action: "send_materials"
          segment: "cold"
          funnel_stage: "strategy"
          limit: 3
        - action: "send_message"
          template: "–ì–æ—Ç–æ–≤—ã –æ–±—Å—É–¥–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ —Å —ç–∫—Å–ø–µ—Ä—Ç–æ–º?"
          buttons:
            - text: "üìû –ù–∞–∑–Ω–∞—á–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é"
              callback: "consult:schedule"
            - text: "‚Ü©Ô∏è –ù–∞–∑–∞–¥"
              callback: "strategy:discuss"
    transitions:
      - trigger: "callback:consult:schedule"
        target: "CONSULT_CTA"
      - trigger: "callback:strategy:discuss"
        target: "STRATEGY_DISCUSSION"

  GROWTH_PATH:
    description: "–°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –Ω–∞ —Ä–æ—Å—Ç + CTA –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏."
    entry:
      steps:
        - action: "send_materials"
          segment: "warm"
          funnel_stage: "strategy"
          limit: 3
        - action: "send_message"
          template: "–ú–æ–∂–µ–º –≤—ã–±—Ä–∞—Ç—å —Å–ª–æ—Ç —Å —ç–∫—Å–ø–µ—Ä—Ç–æ–º –∏ –æ–±—Å—É–¥–∏—Ç—å —Ä–æ—Å—Ç–æ–≤—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏."
          buttons:
            - text: "üìû –í—ã–±—Ä–∞—Ç—å —Å–ª–æ—Ç"
              callback: "consult:schedule"
            - text: "‚Ü©Ô∏è –ù–∞–∑–∞–¥"
              callback: "strategy:discuss"
    transitions:
      - trigger: "callback:consult:schedule"
        target: "CONSULT_CTA"
      - trigger: "callback:strategy:discuss"
        target: "STRATEGY_DISCUSSION"

  SURVEY_ENTRY:
    description: "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∞–Ω–∫–µ—Ç–µ."
    entry:
      steps:
        - action: "send_message"
          template: "–û—Ç–≤–µ—á–∞–π —á–µ—Å—Ç–Ω–æ, —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç –ø–æ–¥–æ–±—Ä–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É."
          buttons:
            - text: "–ù–∞—á–∞—Ç—å"
              callback: "survey:start"
            - text: "–ù–∞–∑–∞–¥"
              callback: "strategy:discuss"
    transitions:
      - trigger: "callback:survey:start"
        target: "SURVEY_Q1"
      - trigger: "callback:strategy:discuss"
        target: "STRATEGY_DISCUSSION"

  SURVEY_Q1:
    type: "survey"
    question: 1
    suppress_fallback: true
    entry:
      steps:
        - action: "ask_survey_question"
          question_id: 1
    transitions:
      - trigger: "survey_answer:q1"
        target: "SURVEY_Q2"

  SURVEY_Q2:
    type: "survey"
    question: 2
    suppress_fallback: true
    entry:
      steps:
        - action: "ask_survey_question"
          question_id: 2
    transitions:
      - trigger: "survey_answer:q2"
        target: "SURVEY_Q3"

  SURVEY_Q3:
    type: "survey"
    question: 3
    suppress_fallback: true
    entry:
      steps:
        - action: "ask_survey_question"
          question_id: 3
    transitions:
      - trigger: "survey_answer:q3"
        target: "SURVEY_Q4"

  SURVEY_Q4:
    type: "survey"
    question: 4
    suppress_fallback: true
    entry:
      steps:
        - action: "ask_survey_question"
          question_id: 4
    transitions:
      - trigger: "survey_answer:q4"
        target: "SURVEY_Q5"

  SURVEY_Q5:
    type: "survey"
    question: 5
    suppress_fallback: true
    entry:
      steps:
        - action: "ask_survey_question"
          question_id: 5
    transitions:
      - trigger: "survey_complete"
        target: "SEGMENT_SUMMARY"

  SEGMENT_SUMMARY:
    description: "LLM-—Å–≤–æ–¥–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∫–µ—Ç—ã."
    entry:
      steps:
        - action: "calculate_segment"
        - action: "send_llm_response"
          prompt: "summarizer.txt"
          context_from: "survey_results"
    transitions:
      - trigger: "segment_calculated"
        target: "SEGMENT_ROUTER"

  SEGMENT_ROUTER:
    description: "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–µ—Ç–∫–∏ –ø–æ —Å–µ–≥–º–µ–Ω—Ç—É/—Å–∫–æ—Ä–∏–Ω–≥—É."
    transitions:
      - trigger: "segment:cold"
        target: "NEWBIE_PATH"
      - trigger: "segment:warm"
        target: "TRADER_PATH"
      - trigger: "segment:hot"
        target: "INVESTOR_PATH"
      - trigger: "segment:escalate"
        target: "SKEPTIC_RECOVERY"

  NEWBIE_PATH:
    description: "–í–µ—Ç–∫–∞ –¥–ª—è cold —Å–µ–≥–º–µ–Ω—Ç–∞."
    entry:
      steps:
        - action: "send_llm_response"
          prompt: "materials_selector.txt"
          context:
            segment: "cold"
            stage: "education"
        - action: "send_materials"
          segment: "cold"
          funnel_stage: "engaged"
          limit: 3
        - action: "send_llm_response"
          prompt: "followups.txt"
          context:
            intent: "bonus_reminder"
    transitions:
      - trigger: "cta:consult"
        target: "CONSULT_CTA"
      - trigger: "cta:materials_more"
        target: "NEWBIE_PATH"

  TRADER_PATH:
    description: "–í–µ—Ç–∫–∞ –¥–ª—è warm —Å–µ–≥–º–µ–Ω—Ç–∞."
    entry:
      steps:
        - action: "send_llm_response"
          prompt: "sales_spin_aida.txt"
          context:
            segment: "warm"
            focus: "portfolio"
        - action: "send_materials"
          segment: "warm"
          funnel_stage: "engaged"
          limit: 3
        - action: "send_llm_response"
          prompt: "consult_offer.txt"
          context:
            urgency: "medium"
    transitions:
      - trigger: "cta:consult"
        target: "CONSULT_CTA"
      - trigger: "cta:objection"
        target: "OBJECTION_LOOP"

  OBJECTION_LOOP:
    description: "–†–∞–±–æ—Ç–∞ —Å –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è–º–∏."
    entry:
      steps:
        - action: "send_llm_response"
          prompt: "followups.txt"
          context:
            intent: "handle_objection"
    transitions:
      - trigger: "objection_resolved"
        target: "CONSULT_CTA"
      - trigger: "objection_unresolved"
        target: "MANAGER_HOT_HANDOFF"

  INVESTOR_PATH:
    description: "–í–µ—Ç–∫–∞ –¥–ª—è hot —Å–µ–≥–º–µ–Ω—Ç–∞."
    entry:
      steps:
        - action: "send_llm_response"
          prompt: "consult_offer.txt"
          context:
            urgency: "high"
            limited_slots: true
        - action: "send_llm_response"
          prompt: "payment_offer.txt"
          context:
            stage: "prepayment"
    transitions:
      - trigger: "cta:consult"
        target: "CONSULT_CTA"
      - trigger: "cta:payment"
        target: "PAYMENT_PREP"

  SKEPTIC_RECOVERY:
    description: "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–æ–≥—Ä–µ–≤–∞–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è–º–∏."
    entry:
      steps:
        - action: "send_llm_response"
          prompt: "safety_policies.txt"
          context:
            intent: "trust_rebuild"
        - action: "send_materials"
          segment: "warm"
          funnel_stage: "skeptic"
          limit: 2
    transitions:
      - trigger: "cta:consult"
        target: "CONSULT_CTA"
      - trigger: "escalate_manager"
        target: "MANAGER_HOT_HANDOFF"

  CONSULT_CTA:
    description: "–ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—ã—Ö–æ–¥–∞ –∫ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏/–º–µ–Ω–µ–¥–∂–µ—Ä—É/–æ–ø–ª–∞—Ç–µ."
    entry:
      steps:
        - action: "send_message"
          template: "–ß—Ç–æ –¥–µ–ª–∞–µ–º –¥–∞–ª—å—à–µ?"
          buttons:
            - text: "üóì –í—ã–±—Ä–∞—Ç—å —Å–ª–æ—Ç"
              callback: "consult:schedule"
            - text: "üë§ –°–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º"
              callback: "manager:request"
            - text: "üí≥ –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ"
              callback: "offer:payment"
    transitions:
      - trigger: "callback:consult:schedule"
        target: "CONSULT_SCHEDULER"
      - trigger: "callback:manager:request"
        target: "MANAGER_HOT_HANDOFF"
      - trigger: "callback:offer:payment"
        target: "PAYMENT_PREP"

  CONSULT_SCHEDULER:
    description: "–í—ã–±–æ—Ä –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏."
    entry:
      steps:
        - action: "propose_slots"
          count_days: 2
          slots: ["12:00", "14:00", "16:00", "18:00"]
    transitions:
      - trigger: "consult_slot_chosen"
        target: "CONSULT_CONFIRMATION"
      - trigger: "consult_slot_declined"
        target: "FOLLOWUP_SEQUENCE"

  CONSULT_CONFIRMATION:
    description: "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è."
    entry:
      steps:
        - action: "schedule_consultation"
        - action: "log_event"
          event_type: "consultation_booked"
        - action: "schedule_reminder"
          before_minutes: 15
    transitions:
      - trigger: "consultation_booked"
        target: "FOLLOWUP_SEQUENCE"

  MANAGER_HOT_HANDOFF:
    description: "–°–æ–∑–¥–∞–Ω–∏–µ –ª–∏–¥–∞ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤."
    entry:
      steps:
        - action: "create_lead"
        - action: "post_manager_notification"
          channel: "telegram"
        - action: "log_event"
          event_type: "lead_created"
    transitions:
      - trigger: "manager_claimed"
        target: "FOLLOWUP_SEQUENCE"
      - trigger: "lead_unclaimed"
        target: "FOLLOWUP_SEQUENCE"

  PAYMENT_PREP:
    description: "–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ —Å–±–æ—Ä —É—Å–ª–æ–≤–∏–π."
    entry:
      steps:
        - action: "send_llm_response"
          prompt: "payment_offer.txt"
          context:
            mode: "collect_terms"
        - action: "collect_payment_preferences"
    transitions:
      - trigger: "payment_link_requested"
        target: "PAYMENT_LINK"
      - trigger: "payment_deferred"
        target: "FOLLOWUP_SEQUENCE"

  PAYMENT_LINK:
    description: "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É."
    entry:
      steps:
        - action: "generate_payment_link"
        - action: "send_message"
          template: "–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É –≥–æ—Ç–æ–≤–∞, –¥–∞—é –≤–∞–º {link}."
    transitions:
      - trigger: "payment_status:paid"
        target: "POST_PAYMENT_SUCCESS"
      - trigger: "payment_status:failed"
        target: "POST_PAYMENT_FAILURE"

  POST_PAYMENT_SUCCESS:
    description: "–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ –∏ –¥–∞–ª—å–Ω–µ–π—à–∏–µ —à–∞–≥–∏."
    entry:
      steps:
        - action: "send_message"
          template: "–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º, –±–ª–∏–∂–∞–π—à–µ–µ –ø–∏—Å—å–º–æ —É–∂–µ —É –≤–∞—Å –Ω–∞ –ø–æ—á—Ç–µ."
        - action: "log_event"
          event_type: "payment_success"
        - action: "trigger_onboarding"
    transitions:
      - trigger: "onboarding_started"
        target: "FOLLOWUP_SEQUENCE"

  POST_PAYMENT_FAILURE:
    description: "–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏ –ø–æ–º–æ—â—å –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –æ–ø–ª–∞—Ç–æ–π."
    entry:
      steps:
        - action: "send_llm_response"
          prompt: "followups.txt"
          context:
            intent: "payment_failed"
        - action: "log_event"
          event_type: "payment_failed"
    transitions:
      - trigger: "cta:retry_payment"
        target: "PAYMENT_LINK"
      - trigger: "escalate_manager"
        target: "MANAGER_HOT_HANDOFF"

  FOLLOWUP_SEQUENCE:
    description: "–î–∞–ª—å–Ω–µ–π—à–∞—è —Ä–∞–±–æ—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (drip, A/B —Ç–µ—Å—Ç—ã)."
    entry:
      steps:
        - action: "schedule_followup"
          cadence: "P2D"
        - action: "enqueue_ab_test"
          experiment: "retargeting_v1"
    transitions:
      - trigger: "followup_completed"
        target: "RETARGETING"

  RETARGETING:
    description: "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≥—Ä–µ–≤—ã –∏ –≤–æ–∑–≤—Ä–∞—Ç –≤ –∞–∫—Ç–∏–≤–Ω—É—é —Å—Ü–µ–Ω—É."
    entry:
      steps:
        - action: "send_llm_response"
          prompt: "followups.txt"
          context:
            intent: "retarget"
        - action: "evaluate_reengagement"
    transitions:
      - trigger: "user_reengaged"
        target: "SEGMENT_ROUTER"
      - trigger: "user_inactive"
        target: "RETARGETING"
